<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NES 模拟器 - 俄罗斯方块 (Tetris)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background-color: #1a1c22; 
        }
        
        #nes-canvas { 
            /* NES 原始分辨率是 256x240 */
            width: 80vw; /* 占据视口宽度的 80% */
            max-width: 800px; /* 最大宽度限制在 800px */
            aspect-ratio: 256 / 240; /* 保持正确的 NES 纵横比 */
            image-rendering: pixelated; /* 保持像素清晰，避免模糊 */
            border: 8px solid #333;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            /* 确保 canvas 能够获得焦点以接收键盘输入 */
            outline: none; 
            cursor: pointer;
        }

        /* 适用于较小设备 (手机) */
        @media (max-width: 600px) {
            #nes-canvas {
                width: 95vw;
                height: auto;
            }
        }
    </style>
</head>
<body>

    <canvas id="nes-canvas" tabindex="0" title="点击并按键盘操作"></canvas>

    <script src="./jsnes.min.js"></script>

    <script>
        // ⚠️ ROM 文件路径：指向您的 /tetris.nes 文件
        const ROM_PATH = './tetris.nes'; 
        
        const canvas = document.getElementById('nes-canvas');
        const ctx = canvas.getContext('2d');
        
        const NES_WIDTH = 256;
        const NES_HEIGHT = 240;

        // 设置 Canvas 尺寸
        canvas.width = NES_WIDTH;
        canvas.height = NES_HEIGHT;
        
        // --- 模拟器核心功能 ---
        const nes = new JSNES.NES({
            onFrame: function(frameBuffer) {
                // 绘制每一帧画面
                const imageData = new ImageData(new Uint8ClampedArray(frameBuffer), NES_WIDTH, NES_HEIGHT);
                ctx.putImageData(imageData, 0, 0);
            },
            // onAudio: (此处省略复杂音频配置，但画面和输入可用)
        });

        // --- 键盘输入映射 (标准 NES 键位) ---
        const MAPPINGS = {
            'w': JSNES.Controller.BUTTON_UP,
        's': JSNES.Controller.BUTTON_DOWN,
        'a': JSNES.Controller.BUTTON_LEFT,
        'd': JSNES.Controller.BUTTON_RIGHT,
        'j': JSNES.Controller.BUTTON_A,
        'k': JSNES.Controller.BUTTON_B,
        ' ': JSNES.Controller.BUTTON_SELECT,
        'Enter': JSNES.Controller.BUTTON_START
        };

        // 绑定键盘事件
        const setButton = (key, state) => {
            const button = MAPPINGS[key.toLowerCase()];
            if (button !== undefined) {
                // 确保只有当 canvas 获得焦点时才处理按键
                if (document.activeElement === canvas) { 
                    nes.getController(1).setButtonState(button, state);
                    if (state) {
                         // 只有按下时阻止默认行为，防止浏览器滚动
                        event.preventDefault(); 
                    }
                }
            }
        };

        canvas.addEventListener('keydown', (e) => setButton(e.key, true));
        canvas.addEventListener('keyup', (e) => setButton(e.key, false));
        canvas.addEventListener('click', () => canvas.focus()); // 点击 canvas 即可获得焦点

        // --- ROM 文件加载 ---
        fetch(ROM_PATH)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`无法加载 ROM 文件 (${response.status} ${response.statusText})`);
                }
                return response.arrayBuffer();
            })
            .then(buffer => {
                const romData = new Uint8Array(buffer);
                nes.loadROM(romData);
                nes.start();
                console.log("NES 模拟器已启动。请点击游戏画面并按 W/A/S/D, J/K 键控制。");
            })
            .catch(error => {
                console.error("加载 ROM 文件失败，请检查路径和文件名是否正确:", error);
                // 在 Canvas 上显示错误信息
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, NES_WIDTH, NES_HEIGHT);
                ctx.fillStyle = 'red';
                ctx.font = '16px sans-serif';
                ctx.fillText("ROM 加载失败! (F12看详情)", 20, 100);
            });
            
    </script>
</body>
</html>


